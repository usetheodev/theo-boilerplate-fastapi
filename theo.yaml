# Theo Build Pipeline Configuration
# https://github.com/usetheodev/theo

version: "1.0"
name: theo-boilerplate-fastapi

# Project metadata
metadata:
  description: "FastAPI + SQLModel + Alembic + UV monorepo"
  framework: fastapi
  language: python
  python_version: "3.12"

# Build configuration
build:
  # Workflow template to use
  template: theo-boilerplate-fastapi-v1

  # Apps configuration
  apps:
    api:
      path: apps/api
      type: fastapi
      port: 3000
      health_endpoint: /health
      dockerfile: |
        FROM python:3.12-slim
        RUN pip install uv
        WORKDIR /app
        COPY apps/api/pyproject.toml apps/api/uv.lock* ./
        RUN uv sync --frozen --no-dev
        COPY apps/api/app ./app
        COPY apps/api/alembic ./alembic
        COPY apps/api/alembic.ini ./
        ENV PATH="/app/.venv/bin:$PATH"
        EXPOSE 3000
        CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "3000"]

    web:
      path: apps/web
      type: vite
      build_command: pnpm build
      output_dir: dist

# Database migrations
migrations:
  enabled: true
  tool: alembic
  command: alembic upgrade head
  path: apps/api

# Environment variables (non-sensitive)
env:
  ENVIRONMENT: production
  PORT: "3000"
  PYTHONUNBUFFERED: "1"

# Frontend environment variables
frontend_env:
  VITE_APP_NAME: "Theo Boilerplate FastAPI"

# Secrets (reference Kubernetes secrets)
secrets:
  name: theo-boilerplate-fastapi-secrets
  keys:
    - DATABASE_URL
    - SECRET_KEY

# Kubernetes deployment
deployment:
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  hpa:
    enabled: false
    min_replicas: 1
    max_replicas: 5
    target_cpu: 70
